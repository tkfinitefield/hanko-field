{{ define "frag_checkout_shipping_table" }}
{{ $lang := .Lang }}
{{ $opts := .Options }}
<section class="space-y-5 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm" aria-live="polite">
  <header class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $lang "ja" }}配送先{{ else }}Destination{{ end }}</p>
      <h2 class="text-xl font-semibold text-gray-900">{{ $opts.CountryLabel }}</h2>
      <p class="text-sm text-gray-600">
        {{ if eq $lang "ja" }}
          郵便番号: {{ if $opts.PostalCode }}{{ $opts.PostalCode }}{{ else }}-{{ end }} · 重量: {{ $opts.WeightDisplay }}
        {{ else }}
          Postal {{ if $opts.PostalCode }}{{ $opts.PostalCode }}{{ else }}—{{ end }} · Weight {{ $opts.WeightDisplay }}
        {{ end }}
      </p>
    </div>
    <a href="/checkout/address"
       class="inline-flex items-center gap-1 rounded-lg border border-gray-200 px-3 py-1.5 text-xs font-semibold text-gray-700 hover:border-gray-300">
      {{ template "icon" (dict "Name" "map-pin" "Class" "h-4 w-4 text-indigo-500") }}
      <span>{{ if eq $lang "ja" }}住所を編集{{ else }}Edit address{{ end }}</span>
    </a>
  </header>

  <form id="checkout-shipping-options-form"
        class="space-y-4"
        hx-post="/checkout/shipping/table"
        hx-target="#checkout-shipping-options-shell"
        hx-trigger="change from:input delay:150ms"
        hx-swap="innerHTML">
    <input type="hidden" name="country" value="{{ $opts.Country }}">
    <input type="hidden" name="postal" value="{{ $opts.PostalCode }}">
    {{ range $opt := $opts.Methods }}
      <label class="flex flex-col gap-3 rounded-2xl border px-4 py-4 text-sm shadow-sm transition {{ if $opt.Selected }}border-indigo-300 bg-indigo-50/70{{ else }}border-gray-200 bg-gray-50{{ end }} {{ if $opt.Disabled }}opacity-60{{ end }}">
        <div class="flex flex-wrap items-start justify-between gap-3">
          <div class="space-y-1">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-base font-semibold text-gray-900">{{ $opt.Label }}</span>
              {{ if $opt.Badge }}
                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide {{ if eq $opt.BadgeTone "success" }}bg-emerald-100 text-emerald-800{{ else if eq $opt.BadgeTone "info" }}bg-indigo-100 text-indigo-800{{ else if eq $opt.BadgeTone "warning" }}bg-amber-100 text-amber-800{{ else }}bg-gray-200 text-gray-700{{ end }}">{{ $opt.Badge }}</span>
              {{ end }}
            </div>
            <p class="text-xs uppercase tracking-wide text-gray-500">{{ $opt.Carrier }}</p>
            <p class="text-sm text-gray-600">{{ $opt.Description }}</p>
            <p class="text-xs text-gray-500">{{ $opt.Window }}</p>
          </div>
          <div class="text-right">
            <p class="text-lg font-semibold text-gray-900">
              {{ if eq $opt.Cost 0 }}
                {{ if eq $lang "ja" }}無料{{ else }}Free{{ end }}
              {{ else }}
                {{ fmtMoney $opt.Cost "JPY" $lang }}
              {{ end }}
            </p>
            <p class="text-xs text-gray-500">{{ $opt.ETA }}</p>
          </div>
        </div>
        {{ if $opt.Highlights }}
          <ul class="flex flex-wrap gap-2 text-xs text-gray-600">
            {{ range $hl := $opt.Highlights }}
              <li class="inline-flex items-center gap-1 rounded-full bg-white/80 px-2 py-0.5">
                {{ template "icon" (dict "Name" "sparkles" "Class" "h-3 w-3 text-indigo-500") }}
                <span>{{ $hl }}</span>
              </li>
            {{ end }}
          </ul>
        {{ end }}
        {{ if $opt.Warning }}
          <p class="text-xs font-medium text-amber-700">{{ $opt.Warning }}</p>
        {{ end }}
        <div class="flex items-center justify-between">
          <span class="text-xs text-gray-500">{{ if eq $lang "ja" }}この方法を選択{{ else }}Select{{ end }}</span>
          <input type="radio" name="method" value="{{ $opt.ID }}" class="h-4 w-4 rounded-full border-gray-300 text-indigo-600 focus:ring-indigo-500" {{ if $opt.Selected }}checked{{ end }} {{ if $opt.Disabled }}disabled{{ end }}>
        </div>
      </label>
    {{ end }}
    <div class="flex items-center justify-between text-xs text-gray-500">
      <span>{{ if eq $lang "ja" }}選択すると自動で更新{{ else }}Changes auto-refresh totals{{ end }}</span>
      <button type="submit" class="text-indigo-600 hover:text-indigo-500">{{ if eq $lang "ja" }}再計算{{ else }}Recalculate{{ end }}</button>
    </div>
  </form>

  {{ if $opts.Notes }}
    <ul class="space-y-1 rounded-xl border border-gray-100 bg-gray-50 px-4 py-3 text-xs text-gray-600">
      {{ range $note := $opts.Notes }}<li>• {{ $note }}</li>{{ end }}
    </ul>
  {{ end }}
</section>

<section class="space-y-4 rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
  <header class="flex items-center justify-between">
    <div>
      <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $lang "ja" }}比較チャート{{ else }}Comparison chart{{ end }}</p>
      <h2 class="text-xl font-semibold text-gray-900">{{ if eq $lang "ja" }}速度 × コスト{{ else }}Speed vs cost{{ end }}</h2>
    </div>
    <p class="text-xs text-gray-500">{{ if eq $lang "ja" }}更新{{ else }}Updated{{ end }} {{ fmtDate $opts.Comparison.UpdatedAt $lang }}</p>
  </header>
  {{ if $opts.Comparison.Entries }}
    <div class="space-y-3">
      {{ range $entry := $opts.Comparison.Entries }}
      <div class="rounded-2xl border border-gray-100 bg-gray-50 p-4">
        <div class="flex flex-wrap items-center justify-between gap-2">
          <div>
            <p class="text-sm font-semibold text-gray-900">{{ $entry.Service }}</p>
            <p class="text-xs uppercase tracking-wide text-gray-500">{{ $entry.Carrier }}</p>
          </div>
          <div class="text-right">
            <p class="text-base font-semibold text-gray-900">{{ fmtMoney $entry.Cost "JPY" $lang }}</p>
            <p class="text-xs text-gray-500">{{ $entry.ETA }}</p>
          </div>
        </div>
        <div class="mt-3 grid gap-3 text-xs text-gray-600 md:grid-cols-2">
          <div>
            <p class="font-semibold text-gray-700">{{ if eq $lang "ja" }}スピード{{ else }}Speed{{ end }}</p>
            <div class="mt-1 flex h-2 items-center gap-1">
              {{ range $i, $_ := seq 5 }}
                <span class="h-1.5 flex-1 rounded-full {{ if lt $i $entry.SpeedScore }}bg-indigo-500{{ else }}bg-gray-200{{ end }}"></span>
              {{ end }}
            </div>
          </div>
          <div>
            <p class="font-semibold text-gray-700">{{ if eq $lang "ja" }}コスト効率{{ else }}Cost efficiency{{ end }}</p>
            <div class="mt-1 flex h-2 items-center gap-1">
              {{ range $i, $_ := seq 5 }}
                <span class="h-1.5 flex-1 rounded-full {{ if lt $i $entry.CostScore }}bg-emerald-500{{ else }}bg-gray-200{{ end }}"></span>
              {{ end }}
            </div>
          </div>
        </div>
        {{ if $entry.Badge }}
          <p class="mt-2 inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide {{ if eq $entry.BadgeTone "success" }}bg-emerald-100 text-emerald-800{{ else if eq $entry.BadgeTone "info" }}bg-indigo-100 text-indigo-800{{ else if eq $entry.BadgeTone "warning" }}bg-amber-100 text-amber-800{{ else }}bg-gray-100 text-gray-700{{ end }}">{{ $entry.Badge }}</p>
        {{ end }}
      </div>
      {{ end }}
    </div>
  {{ else }}
    <p class="text-sm text-gray-600">{{ if eq $lang "ja" }}比較する配送方法がありません。{{ else }}No comparison data available yet.{{ end }}</p>
  {{ end }}
</section>
{{ end }}
