{{ define "c_template_filters" }}
{{ $filters := .Filters }}
{{ $options := .Options }}
{{ $total := .Total }}
{{ $per := .Per }}
<form id="template-filters"
      class="rounded-xl border border-gray-200 bg-white/70 px-4 py-4 shadow-sm backdrop-blur"
      hx-get="/templates/table"
      hx-target="#template-results"
      hx-swap="outerHTML"
      hx-push-url="true"
      hx-trigger="change from:select, change from:input[type=radio], change from:input[type=checkbox], keyup changed delay:450ms from:input[name=q]">
  <input type="hidden" name="page" value="1">
  <input type="hidden" name="per" value="{{ $per }}">
  <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
    <div class="flex flex-wrap items-center gap-3 text-sm text-gray-600">
      <span class="font-medium text-gray-900">{{ $total }} templates</span>
      {{ with index $filters "Script" }}
        {{ if . }}
          <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-600">
            Script: {{ . }}
          </span>
        {{ end }}
      {{ end }}
      {{ with index $filters "Shape" }}
        {{ if . }}
          <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-600">
            Shape: {{ . }}
          </span>
        {{ end }}
      {{ end }}
      {{ with index $filters "Registrability" }}
        {{ if . }}
          <span class="inline-flex items-center gap-1 rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-600">
            Registrability: {{ . }}
          </span>
        {{ end }}
      {{ end }}
    </div>
    <div class="flex w-full flex-col gap-3 sm:flex-row sm:items-center sm:gap-4 lg:w-auto">
      <div class="relative flex-1">
        <label for="template-search" class="sr-only">Search templates</label>
        <input id="template-search"
               name="q"
               value="{{ index $filters "Query" }}"
               type="search"
               placeholder="Search by name, tag, or use case"
               class="w-full rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      </div>
      <div class="flex items-center gap-2">
        <label class="sr-only" for="filter-style">Style</label>
        <select id="filter-style"
                name="style"
                class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          {{ range $opt := index $options "Styles" }}
            <option value="{{ $opt.Value }}" {{ if $opt.Selected }}selected{{ end }}>{{ $opt.Label }}</option>
          {{ end }}
        </select>
        <label class="sr-only" for="filter-locale">Locale</label>
        <select id="filter-locale"
                name="locale"
                class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
          {{ range $opt := index $options "Locales" }}
            <option value="{{ $opt.Value }}" {{ if $opt.Selected }}selected{{ end }}>{{ $opt.Label }}</option>
          {{ end }}
        </select>
      </div>
    </div>
  </div>

  <div class="mt-5 grid grid-cols-1 gap-4 md:grid-cols-4">
    <div class="md:col-span-2">
      <div class="text-xs font-semibold uppercase tracking-wide text-gray-500">Category</div>
      <div class="mt-2 flex flex-wrap gap-2" role="radiogroup" aria-label="Filter by category">
        {{ range $opt := index $options "Categories" }}
          {{ $value := $opt.Value }}
          {{ if eq $value "" }}{{ $value = "all" }}{{ end }}
          {{ $id := printf "filter-category-%s" $value }}
          <div>
            <input type="radio"
                   name="category"
                   value="{{ $opt.Value }}"
                   id="{{ $id }}"
                   class="peer sr-only"
                   {{ if $opt.Selected }}checked{{ end }}>
            <label for="{{ $id }}"
                   class="inline-flex cursor-pointer items-center gap-2 rounded-full border px-3 py-1.5 text-sm font-medium transition peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-600 peer-checked:shadow-sm hover:border-indigo-300 hover:text-indigo-600">
              <span>{{ $opt.Label }}</span>
              <span class="text-xs text-gray-400">{{ $opt.Count }}</span>
            </label>
          </div>
        {{ end }}
      </div>
    </div>
    <div>
      <label for="filter-script" class="text-xs font-semibold uppercase tracking-wide text-gray-500">Script</label>
      <select id="filter-script"
              name="script"
              class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        {{ range $opt := index $options "Scripts" }}
          <option value="{{ $opt.Value }}" {{ if $opt.Selected }}selected{{ end }}>{{ $opt.Label }}</option>
        {{ end }}
      </select>
    </div>
    <div>
      <label for="filter-shape" class="text-xs font-semibold uppercase tracking-wide text-gray-500">Shape</label>
      <select id="filter-shape"
              name="shape"
              class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        {{ range $opt := index $options "Shapes" }}
          <option value="{{ $opt.Value }}" {{ if $opt.Selected }}selected{{ end }}>{{ $opt.Label }}</option>
        {{ end }}
      </select>
    </div>
    <div>
      <label for="filter-registrability" class="text-xs font-semibold uppercase tracking-wide text-gray-500">Registrability</label>
      <select id="filter-registrability"
              name="registrability"
              class="mt-2 w-full rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500">
        {{ range $opt := index $options "Registrability" }}
          <option value="{{ $opt.Value }}" {{ if $opt.Selected }}selected{{ end }}>{{ $opt.Label }}</option>
        {{ end }}
      </select>
    </div>
  </div>

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs text-gray-500">
    <div>Filters update instantly; use clear to reset quickly.</div>
    <div class="flex items-center gap-2">
      <a href="/templates"
         class="inline-flex items-center rounded-md border border-gray-200 px-3 py-1.5 text-sm font-medium text-gray-600 hover:border-indigo-300 hover:text-indigo-600">Clear</a>
      <button type="submit"
              class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 focus:ring-offset-2">
        Apply filters
      </button>
    </div>
  </div>
</form>
{{ end }}

{{ define "c_template_card" }}
{{ $tpl := .Template }}
{{ $lang := .Lang }}
<article class="template-card group relative flex h-full flex-col overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm transition hover:-translate-y-1 hover:shadow-lg focus-within:ring-2 focus-within:ring-indigo-500">
  <div class="relative">
    <div class="aspect-video overflow-hidden">
      <div class="flex h-full items-center justify-center {{ $tpl.Preview.Background }}">
        <div class="rounded-full px-4 py-3 text-center uppercase {{ $tpl.Preview.GlyphClass }} {{ $tpl.Preview.RingClass }}">
          {{ $tpl.Preview.Glyph }}
        </div>
      </div>
    </div>
    {{ if $tpl.Badge }}
      <span class="absolute left-4 top-4 inline-flex items-center rounded-full bg-white/80 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600 shadow-sm">{{ $tpl.Badge }}</span>
    {{ end }}
    <button type="button"
            class="absolute inset-0"
            aria-label="Quick preview {{ $tpl.Name }}"
            hx-get="/templates/{{ $tpl.ID }}"
            hx-target="#template-drawer-root"
            hx-swap="innerHTML"
            hx-push-url="false"></button>
  </div>
  <div class="flex flex-1 flex-col gap-3 p-5">
    <header class="space-y-1.5">
      <p class="text-xs uppercase tracking-wide text-indigo-500">{{ $tpl.CategoryLabel }}</p>
      <h3 class="text-lg font-semibold text-gray-900">{{ $tpl.Name }}</h3>
      <p class="text-sm text-gray-600 line-clamp-2">{{ $tpl.Summary }}</p>
    </header>
    <dl class="grid grid-cols-2 gap-3 text-xs text-gray-500">
      <div>
        <dt class="font-medium text-gray-700">Script</dt>
        <dd class="mt-0.5">{{ $tpl.ScriptLabel }}</dd>
      </div>
      <div>
        <dt class="font-medium text-gray-700">Shape</dt>
        <dd class="mt-0.5">{{ $tpl.ShapeLabel }}</dd>
      </div>
      <div>
        <dt class="font-medium text-gray-700">Registrability</dt>
        <dd class="mt-0.5">{{ $tpl.RegistrabilityLabel }}</dd>
      </div>
      <div>
        <dt class="font-medium text-gray-700">Locale</dt>
        <dd class="mt-0.5">{{ $tpl.LocaleLabel }}</dd>
      </div>
    </dl>
    <div class="flex items-center justify-between text-xs text-gray-500">
      <span class="font-medium text-gray-700">{{ $tpl.PrimarySize }}</span>
      <span>Updated {{ fmtDate $tpl.Updated $lang }}</span>
    </div>
    <div class="flex items-center justify-between text-xs text-gray-500">
      <span>{{ $tpl.Usage }} uses</span>
      <span>{{ $tpl.Favorites }} saved</span>
    </div>
    <div class="mt-auto flex items-center gap-2">
      {{ template "c_button" (dict "Label" "Start design" "Href" (printf "/design?template=%s" $tpl.ID) "Variant" "primary" "Size" "sm") }}
      {{ template "c_button" (dict "Label" "Preview" "Variant" "outline" "Size" "sm" "Attrs" (dict "hx-get" (printf "/templates/%s" $tpl.ID) "hx-target" "#template-drawer-root" "hx-swap" "innerHTML" "hx-push-url" "false")) }}
    </div>
  </div>
</article>
{{ end }}

{{ define "c_template_waypoint_loader" }}
<div class="template-waypoint md:col-span-2 xl:col-span-3"
     hx-get="{{ .NextURL }}"
     hx-trigger="revealed"
     hx-target="this"
     hx-swap="outerHTML">
  <div class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3">
    {{ template "c_skeleton_card" . }}
    {{ template "c_skeleton_card" . }}
    {{ template "c_skeleton_card" . }}
  </div>
</div>
{{ end }}

{{ define "c_template_empty_state" }}
<div class="template-empty col-span-full flex flex-col items-center justify-center gap-4 rounded-xl border border-dashed border-gray-300 bg-white/70 p-10 text-center shadow-sm">
  <div>
    <h3 class="text-xl font-semibold text-gray-900">No templates found</h3>
    <p class="mt-2 text-sm text-gray-600">Adjust the filters or request a custom layout from the design team.</p>
  </div>
  <div class="flex items-center gap-3">
    <a href="/templates"
       class="inline-flex items-center rounded-md border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:border-indigo-300 hover:text-indigo-600">Reset filters</a>
    <a href="/guides/template-request"
       class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-500">Request template</a>
  </div>
</div>
{{ end }}

{{ define "c_template_detail" }}
{{ $detail := .Detail }}
{{ $lang := .Lang }}
<div class="flex flex-col gap-6">
  <header class="space-y-3">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <p class="text-xs uppercase tracking-wide text-indigo-500">{{ $detail.Template.CategoryLabel }}</p>
        <h2 class="text-2xl font-bold text-gray-900">{{ $detail.Template.Name }}</h2>
      </div>
      {{ if $detail.Template.Badge }}
        <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">{{ $detail.Template.Badge }}</span>
      {{ end }}
    </div>
    <p class="text-sm text-gray-600">{{ if $detail.Lead }}{{ $detail.Lead }}{{ else }}{{ $detail.Template.Summary }}{{ end }}</p>
    <div class="flex flex-wrap gap-2 text-xs text-gray-500">
      <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-700">{{ $detail.Template.ScriptLabel }}</span>
      <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-700">{{ $detail.Template.ShapeLabel }}</span>
      <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-700">{{ $detail.Template.RegistrabilityLabel }}</span>
      <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-700">{{ $detail.Template.LocaleLabel }}</span>
      <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1 font-medium text-gray-700">{{ $detail.Template.PrimarySize }}</span>
    </div>
  </header>

  <section class="grid gap-4 rounded-xl border border-gray-200 bg-white p-4 shadow-sm sm:grid-cols-2">
    <div>
      <div class="text-xs uppercase text-gray-500">Template uses</div>
      <div class="mt-1 text-lg font-semibold text-gray-900">{{ $detail.Stats.Usage }}</div>
    </div>
    <div>
      <div class="text-xs uppercase text-gray-500">Saved</div>
      <div class="mt-1 text-lg font-semibold text-gray-900">{{ $detail.Stats.Favorites }}</div>
    </div>
    <div>
      <div class="text-xs uppercase text-gray-500">Satisfaction</div>
      <div class="mt-1 text-lg font-semibold text-gray-900">{{ $detail.Stats.Satisfaction }}%</div>
    </div>
    <div>
      <div class="text-xs uppercase text-gray-500">Updated</div>
      <div class="mt-1 text-lg font-semibold text-gray-900">{{ fmtDate $detail.Stats.LastUpdated $lang }}</div>
      <p class="text-xs text-gray-500">{{ $detail.Stats.AvgTurnaround }}</p>
    </div>
  </section>

  <section>
    <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-700">Recommended sizes</h3>
    <div class="mt-3 grid gap-3">
      {{ range $detail.RecommendedSizes }}
        <div class="rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
          <div class="flex items-center justify-between gap-2 text-sm font-medium text-gray-800">
            <span>{{ .Label }}</span>
            <span class="text-xs text-gray-500">{{ .Dimensions }}</span>
          </div>
          <p class="mt-2 text-xs text-gray-600">{{ .Usage }}</p>
        </div>
      {{ end }}
    </div>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <div>
      <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-700">Constraints</h3>
      <ul class="mt-3 space-y-2">
        {{ range $detail.Constraints }}
          <li class="rounded-lg border border-gray-200 bg-white px-4 py-3 text-sm text-gray-700 shadow-sm">
            <span class="block font-medium text-gray-800">{{ .Label }}</span>
            <span class="block text-xs text-gray-600">{{ .Description }}</span>
          </li>
        {{ end }}
      </ul>
    </div>
    <div>
      <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-700">Preview</h3>
      <div class="mt-3 grid gap-3">
        {{ range $detail.PreviewShots }}
          <div class="overflow-hidden rounded-xl border border-gray-200 bg-white shadow-sm">
            <div class="relative aspect-video overflow-hidden">
              <div class="{{ .Background }} flex h-full items-center justify-center">
                <span class="{{ .GlyphClass }} {{ .RingClass }}">{{ .Glyph }}</span>
              </div>
            </div>
            <div class="px-4 py-3">
              <div class="text-sm font-medium text-gray-800">{{ .Label }}</div>
              <p class="mt-1 text-xs text-gray-600">{{ .Caption }}</p>
            </div>
          </div>
        {{ end }}
      </div>
    </div>
  </section>

  <section class="grid gap-4 lg:grid-cols-2">
    <div>
      <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-700">Metadata</h3>
      <dl class="mt-3 space-y-3">
        {{ range $detail.Metadata }}
          <div class="rounded-lg border border-gray-200 bg-white px-4 py-3 shadow-sm">
            <dt class="text-xs uppercase text-gray-500">{{ .Label }}</dt>
            <dd class="mt-1 text-sm font-medium text-gray-900">{{ .Value }}</dd>
            {{ if .Hint }}<p class="mt-1 text-xs text-gray-500">{{ .Hint }}</p>{{ end }}
          </div>
        {{ end }}
      </dl>
    </div>
    <div>
      <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-700">Use cases</h3>
      <ul class="mt-3 space-y-2">
        {{ range $detail.UseCases }}
          <li class="flex items-start gap-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm text-gray-600 shadow-sm">
            <span class="mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full bg-indigo-500"></span>
            <span>{{ . }}</span>
          </li>
        {{ end }}
      </ul>
      {{ if $detail.RecommendedInks }}
        <div class="mt-4">
          <h4 class="text-xs uppercase text-gray-500">Recommended inks</h4>
          <div class="mt-2 flex flex-wrap gap-2">
            {{ range $detail.RecommendedInks }}
              <span class="inline-flex items-center rounded-full bg-indigo-50 px-3 py-1 text-xs font-medium text-indigo-600">{{ . }}</span>
            {{ end }}
          </div>
        </div>
      {{ end }}
    </div>
  </section>
</div>
{{ end }}

{{ define "c_template_drawer" }}
{{ $detail := .Detail }}
{{ $lang := .Lang }}
<div class="fixed inset-0 z-50 flex items-start justify-end" role="dialog" aria-modal="true" data-template-drawer>
  <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm" data-template-drawer-overlay></div>
  <aside class="relative ml-auto h-full w-full max-w-xl overflow-y-auto bg-white shadow-2xl">
    <div class="flex items-center justify-between border-b border-gray-200 px-5 py-4">
      <div>
        <p class="text-xs uppercase tracking-wide text-indigo-500">{{ $detail.Template.CategoryLabel }}</p>
        <h2 class="text-lg font-semibold text-gray-900">{{ $detail.Template.Name }}</h2>
      </div>
      {{ template "c_button" (dict "Label" "Close" "Variant" "ghost" "Size" "sm" "Attrs" (dict "data-template-drawer-close" "true")) }}
    </div>
    <div class="px-5 py-6">
      {{ template "c_template_detail" (dict "Detail" $detail "Lang" $lang) }}
      <div class="mt-6 flex flex-wrap gap-2">
        {{ range $action := $detail.Actions }}
          {{ template "c_button" (dict "Label" $action.Label "Href" $action.Href "Variant" $action.Variant "Size" "sm") }}
        {{ end }}
        {{ template "c_button" (dict "Label" "Close" "Variant" "outline" "Size" "sm" "Attrs" (dict "data-template-drawer-close" "true")) }}
      </div>
    </div>
  </aside>
</div>
<script>
  (function() {
    var root = document.getElementById('template-drawer-root');
    if (!root) { return; }
    var close = function(ev) {
      if (ev) { ev.preventDefault(); }
      root.innerHTML = '';
    };
    root.querySelectorAll('[data-template-drawer-close]').forEach(function(btn) {
      btn.addEventListener('click', close);
    });
    var overlay = root.querySelector('[data-template-drawer-overlay]');
    if (overlay) {
      overlay.addEventListener('click', close);
    }
  })();
</script>
{{ end }}

{{ define "c_template_related_card" }}
{{ $tpl := .Template }}
<div class="flex items-center gap-3 rounded-lg border border-gray-200 bg-white px-3 py-3 shadow-sm">
  <div class="flex h-12 w-12 items-center justify-center rounded-full {{ $tpl.Preview.Background }}">
    <span class="text-sm font-semibold uppercase tracking-widest text-white">{{ $tpl.Preview.Glyph }}</span>
  </div>
  <div class="min-w-0 flex-1">
    <div class="truncate text-sm font-medium text-gray-900">{{ $tpl.Name }}</div>
    <p class="truncate text-xs text-gray-500">{{ $tpl.Summary }}</p>
  </div>
  <a href="/templates/{{ $tpl.ID }}" class="text-xs font-semibold text-indigo-600 hover:text-indigo-500">View</a>
</div>
{{ end }}
