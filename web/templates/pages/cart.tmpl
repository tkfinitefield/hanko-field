{{ define "content" }}
{{ $view := $.Cart }}
<section id="cart-root" class="py-6 space-y-6">
  <header class="space-y-5 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
    <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
      {{ range $i, $crumb := $.Breadcrumbs }}
        {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
        {{ if $crumb.Active }}
          <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
        {{ else }}
          <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
        {{ end }}
      {{ end }}
    </nav>
    <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
      <div class="space-y-3">
        <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ if eq $.Lang "ja" }}チェックアウト{{ else }}Checkout{{ end }}</p>
        <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ if eq $.Lang "ja" }}カートと見積もり{{ else }}Cart & estimate{{ end }}</h1>
        <p class="text-sm text-gray-600">
          {{ if eq $.Lang "ja" }}
            印影、刻印メモ、配送オプションを確定し、見積もりを更新できます。
          {{ else }}
            Finalize each seal, confirm engraving notes, and refresh your fulfillment estimate before checkout.
          {{ end }}
        </p>
      </div>
      <a href="/shop" class="inline-flex items-center justify-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:border-gray-300 hover:text-gray-900">
        {{ if eq $.Lang "ja" }}買い物を続ける{{ else }}Continue shopping{{ end }}
      </a>
    </div>
    {{ if $view.Steps }}
      <ol class="grid gap-3 md:grid-cols-4" aria-label="{{ if eq $.Lang "ja" }}進捗状況{{ else }}Checkout progress{{ end }}">
        {{ range $view.Steps }}
          <li class="flex items-center gap-3 rounded-xl border px-3 py-2 text-sm {{ if .Active }}border-indigo-200 bg-indigo-50 text-indigo-700{{ else if .Completed }}border-emerald-200 bg-emerald-50 text-emerald-700{{ else }}border-gray-200 bg-gray-50 text-gray-500{{ end }}">
            <span class="inline-flex h-6 w-6 flex-none items-center justify-center rounded-full text-xs font-semibold {{ if .Active }}bg-indigo-600 text-white{{ else if .Completed }}bg-emerald-500 text-white{{ else }}bg-gray-200 text-gray-600{{ end }}">
              {{ if eq .Key "cart" }}1{{ else if eq .Key "shipping" }}2{{ else if eq .Key "payment" }}3{{ else }}4{{ end }}
            </span>
            <div>
              <p class="font-semibold">{{ .Label }}</p>
              <p class="text-xs text-gray-500">{{ .Description }}</p>
            </div>
          </li>
        {{ end }}
      </ol>
    {{ end }}
    {{ if and $view.Alerts (not $view.Empty) }}
      <div class="rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
        {{ range $view.Alerts }}
          <div class="flex items-start gap-3">
            <span aria-hidden="true" class="inline-flex h-6 w-6 flex-none items-center justify-center rounded-full bg-amber-200 text-amber-800">
              {{ template "icon" (dict "Name" (or .Icon "information-circle") "Class" "h-4 w-4") }}
            </span>
            <div>
              <p class="font-semibold">{{ .Title }}</p>
              <p class="text-xs text-amber-800/90">{{ .Body }}</p>
            </div>
          </div>
        {{ end }}
      </div>
    {{ end }}
  </header>

  {{ if $view.Empty }}
    <div class="rounded-2xl border border-dashed border-gray-300 bg-white p-10 text-center shadow-sm">
      <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-gray-100 text-gray-500">
        {{ template "icon" (dict "Name" "shopping-bag" "Class" "h-8 w-8") }}
      </div>
      <h2 class="mt-4 text-2xl font-semibold text-gray-900">{{ if eq $.Lang "ja" }}カートは空です{{ else }}Your cart is empty{{ end }}</h2>
      <p class="mt-2 text-sm text-gray-600">
        {{ if eq $.Lang "ja" }}
          デザイン済みの印影やテンプレをカートに追加するとここに表示されます。
        {{ else }}
          Designs and accessories you add will appear here. Explore the catalog to get started.
        {{ end }}
      </p>
      <div class="mt-6 flex flex-wrap justify-center gap-3">
        <a href="/shop" class="inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-sm font-semibold text-white hover:bg-indigo-500">
          {{ if eq $.Lang "ja" }}素材から探す{{ else }}Browse the shop{{ end }}
        </a>
        <a href="/design/new" class="inline-flex items-center justify-center rounded-lg border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:border-gray-300 hover:text-gray-900">
          {{ if eq $.Lang "ja" }}印影を作成{{ else }}Start a design{{ end }}
        </a>
      </div>
    </div>
  {{ else }}
    <div class="grid gap-6 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
      <div id="cart-table-shell">
        {{ slot "frag_cart_table" $view }}
      </div>
      <div id="cart-estimate-shell">
        {{ slot "frag_cart_estimate" (dict "Lang" $.Lang "Estimate" $view.Estimate "Promo" $view.Promo "Shipping" $view.Shipping) }}
      </div>
    </div>
  {{ end }}

  {{ if $view.CrossSell }}
    <section aria-labelledby="cart-cross-sell" class="space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}おすすめ{{ else }}Recommended addons{{ end }}</p>
          <h2 id="cart-cross-sell" class="text-xl font-semibold text-gray-900">{{ if eq $.Lang "ja" }}あわせて人気のアクセサリ{{ else }}Popular accessories{{ end }}</h2>
        </div>
        <a href="/shop" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">{{ if eq $.Lang "ja" }}すべて見る{{ else }}See all{{ end }}</a>
      </div>
      {{ template "c_product_rail" (dict "Lang" $.Lang "Items" $view.CrossSell) }}
    </section>
  {{ end }}

  <div class="text-xs text-gray-500">Path: {{ $.Path }}</div>
</section>

<script>
(function(){
  if (window.__cartInit) { return; }
  window.__cartInit = true;

  function ensureHTMX(){
    if (!window.htmx) { throw new Error('htmx missing'); }
    return window.htmx;
  }

  function initSteppers(scope){
    if (!scope || !scope.querySelectorAll) { return; }
    scope.querySelectorAll('[data-stepper]').forEach(function(root){
      if (root.__stepperReady) { return; }
      root.__stepperReady = true;
      var input = root.querySelector('[data-stepper-input]');
      if (!input) { return; }
      root.querySelectorAll('[data-stepper-action]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var delta = parseInt(btn.getAttribute('data-stepper-action') || '1', 10);
          if (isNaN(delta)) { delta = 1; }
          var min = parseInt(input.getAttribute('min') || '1', 10);
          var max = parseInt(input.getAttribute('max') || '99', 10);
          var value = parseInt(input.value || String(min), 10);
          if (isNaN(value)) { value = min; }
          value += delta;
          if (value < min) { value = min; }
          if (value > max) { value = max; }
          input.value = value;
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new Event('change', { bubbles: true }));
        });
      });
    });
  }

  function setupEstimator(scope){
    if (!scope) { return; }
    var form = scope.querySelector('#cart-estimator-form');
    if (!form || form.__estimatorReady) { return; }
    form.__estimatorReady = true;
    form.addEventListener('change', function(){
      try {
        ensureHTMX().trigger(form, 'submit');
      } catch (_) {}
    });
  }

  initSteppers(document);
  setupEstimator(document.getElementById('cart-estimate-shell'));

  document.addEventListener('htmx:afterSwap', function(event){
    if (!event.target) { return; }
    if (event.target.id === 'cart-table-shell' || event.target.querySelector('[data-cart-table]')) {
      initSteppers(event.target);
    }
    if (event.target.id === 'cart-estimate-shell') {
      initSteppers(event.target);
      setupEstimator(event.target);
    }
  });

  document.body.addEventListener('cart:promo-applied', function(event){
    var detail = event.detail || {};
    var code = detail.code || '';
    var shell = document.getElementById('cart-estimate-shell');
    var form = shell ? shell.querySelector('#cart-estimator-form') : null;
    if (form) {
      var promoInput = form.querySelector('input[name="promo"]');
      if (promoInput) { promoInput.value = code; }
      try {
        ensureHTMX().trigger(form, 'submit');
      } catch (_) {}
    }
    if (window.hankoModalClose) {
      window.hankoModalClose();
    }
  });
})();
</script>
{{ end }}
