{{ define "content" }}
{{ $view := $.Checkout }}
<section id="checkout-payment-root" class="py-6 space-y-6">
  <header class="space-y-5 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
    <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
      {{ range $i, $crumb := $.Breadcrumbs }}
        {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
        {{ if $crumb.Active }}
          <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
        {{ else }}
          <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
        {{ end }}
      {{ end }}
    </nav>
    <div class="space-y-3">
      <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ if eq $.Lang "ja" }}チェックアウト{{ else }}Checkout{{ end }}</p>
      <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ if eq $.Lang "ja" }}支払い方法{{ else }}Secure your payment{{ end }}</h1>
      <p class="text-sm text-gray-600">
        {{ if eq $.Lang "ja" }}社内で保存済みのカードを利用するか、Stripe セッションを開始してウォレット決済を行えます。{{ else }}Use a saved corporate card or launch a Stripe session for wallets and bank redirects. We’ll hold your cart until payment is confirmed.{{ end }}
      </p>
    </div>
    {{ if $view.Steps }}
      <ol class="grid gap-3 md:grid-cols-4" aria-label="{{ if eq $.Lang "ja" }}進捗状況{{ else }}Checkout progress{{ end }}">
        {{ range $view.Steps }}
          <li class="flex items-center gap-3 rounded-xl border px-3 py-2 text-sm {{ if .Active }}border-indigo-200 bg-indigo-50 text-indigo-700{{ else if .Completed }}border-emerald-200 bg-emerald-50 text-emerald-700{{ else }}border-gray-200 bg-gray-50 text-gray-500{{ end }}">
            <span class="inline-flex h-6 w-6 flex-none items-center justify-center rounded-full text-xs font-semibold {{ if .Active }}bg-indigo-600 text-white{{ else if .Completed }}bg-emerald-500 text-white{{ else }}bg-gray-200 text-gray-600{{ end }}">
              {{ if eq .Key "cart" }}1{{ else if eq .Key "shipping" }}2{{ else if eq .Key "payment" }}3{{ else }}4{{ end }}
            </span>
            <div>
              <p class="font-semibold">{{ .Label }}</p>
              <p class="text-xs text-gray-500">{{ .Description }}</p>
            </div>
          </li>
        {{ end }}
      </ol>
    {{ end }}
    {{ if $view.Alerts }}
      <div class="space-y-3">
        {{ range $alert := $view.Alerts }}
          {{ template "c_inline_alert" (dict "Tone" $alert.Tone "Icon" $alert.Icon "Title" $alert.Title "Body" $alert.Body) }}
        {{ end }}
      </div>
    {{ end }}
  </header>

  <div class="grid gap-6 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
    <div class="space-y-6">
      <section class="space-y-4 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <header class="flex flex-col gap-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}保存済みカード{{ else }}Saved payment methods{{ end }}</p>
          <h2 class="text-2xl font-bold text-gray-900">{{ if eq $.Lang "ja" }}社内カード or 与信枠{{ else }}Charge an approved card{{ end }}</h2>
          <p class="text-sm text-gray-600">{{ if eq $.Lang "ja" }}オペレーションチームが登録したカード情報にアクセスできます。選択後にすぐ決済が実行されます。{{ else }}Use cards managed by operations. Selecting a method and submitting will run the charge instantly.{{ end }}</p>
        </header>
        {{ if $view.SavedMethods }}
          <form id="checkout-saved-methods-form"
                class="space-y-4"
                hx-post="/checkout/payment/confirm"
                hx-target="#checkout-payment-direct-status"
                hx-swap="innerHTML">
            <div class="space-y-3">
              {{ range $method := $view.SavedMethods }}
                <label class="flex flex-col gap-2 rounded-2xl border px-4 py-3 text-sm shadow-sm transition hover:border-indigo-300 {{ if eq $view.SelectedMethodID $method.ID }}border-indigo-400 ring-1 ring-indigo-200 bg-indigo-50/40{{ else }}border-gray-200 bg-white{{ end }}">
                  <div class="flex items-center gap-3">
                    <input type="radio" name="method_id" value="{{ $method.ID }}" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500" {{ if eq $view.SelectedMethodID $method.ID }}checked{{ end }}>
                    <div class="flex-1">
                      <p class="font-semibold text-gray-900">{{ $method.Label }}</p>
                      <p class="text-xs text-gray-500">{{ $method.Subtitle }}</p>
                    </div>
                    {{ if $method.Badge }}
                      <span class="rounded-full px-3 py-0.5 text-xs font-semibold {{ if eq $method.BadgeTone "success" }}bg-emerald-50 text-emerald-700{{ else if eq $method.BadgeTone "warning" }}bg-amber-50 text-amber-700{{ else }}bg-gray-100 text-gray-600{{ end }}">{{ $method.Badge }}</span>
                    {{ end }}
                  </div>
                  <div class="flex flex-wrap items-center gap-3 text-xs text-gray-500">
                    <span>{{ if eq $.Lang "ja" }}更新: {{ fmtDate $method.UpdatedAt $.Lang }}{{ else }}Updated {{ fmtDate $method.UpdatedAt $.Lang }}{{ end }}</span>
                    {{ if $method.Editable }}
                      <a href="/account#payments" class="inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-500">
                        {{ if eq $.Lang "ja" }}編集{{ else }}Edit{{ end }}
                        {{ template "icon" (dict "Name" "document-text" "Class" "h-4 w-4") }}
                      </a>
                    {{ end }}
                  </div>
                </label>
              {{ end }}
            </div>
            <input type="hidden" name="provider" value="vault">
            <div id="checkout-payment-direct-status"></div>
            <div class="flex flex-col gap-3 md:flex-row md:items-center">
              <button type="submit" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-3 text-base font-semibold text-white hover:bg-indigo-500">{{ if eq $.Lang "ja" }}選択したカードで決済{{ else }}Charge selected method{{ end }}</button>
              <p class="text-xs text-gray-500">{{ if eq $.Lang "ja" }}送信後すぐに与信を取得します。{{ else }}We’ll capture funds immediately after you submit.{{ end }}</p>
            </div>
          </form>
        {{ else }}
          <p class="rounded-xl bg-gray-50 p-4 text-sm text-gray-600">{{ if eq $.Lang "ja" }}保存済みの支払い方法がありません。{{ else }}No saved methods yet—add one from your account settings.{{ end }}</p>
        {{ end }}
      </section>

      <section class="space-y-5 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
        <header class="space-y-1">
          <p class="text-xs font-semibold uppercase tracking-wide text-gray-500">Stripe</p>
          <h2 class="text-2xl font-bold text-gray-900">{{ if eq $.Lang "ja" }}Stripe セッション経由で支払う{{ else }}Start a Stripe-hosted session{{ end }}</h2>
          <p class="text-sm text-gray-600">{{ if eq $.Lang "ja" }}Apple Pay / 銀行リダイレクト / 請求書決済を含む Stripe Checkout を起動します。{{ else }}Launch Stripe Checkout for wallets, bank redirects, and invoice-friendly cards.{{ end }}</p>
        </header>
        <div id="checkout-payment-status"></div>
        <form id="checkout-payment-session-form"
              class="flex flex-col gap-3 rounded-2xl border border-dashed border-indigo-200 bg-indigo-50/70 p-4"
              hx-post="/checkout/payment/session"
              hx-target="#checkout-payment-status"
              hx-swap="innerHTML">
          <input type="hidden" name="provider" value="{{ $view.PaymentState.Provider }}">
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm font-semibold text-indigo-900">{{ if eq $.Lang "ja" }}Stripe で支払いを開始{{ else }}Request payment session{{ end }}</p>
              <p class="text-xs text-indigo-700">{{ if eq $.Lang "ja" }}戻るリンク: {{ $view.ReturnURL }}{{ else }}We’ll send Stripe back to {{ $view.ReturnURL }}{{ end }}</p>
            </div>
            <button type="submit" class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-3 text-base font-semibold text-white hover:bg-indigo-500">
              {{ if eq $.Lang "ja" }}Stripe へ進む{{ else }}Start Stripe session{{ end }}
            </button>
          </div>
        </form>
        <div class="space-y-3 rounded-2xl border border-gray-100 bg-gray-50 p-4">
          <p class="text-sm font-semibold text-gray-900">{{ if eq $.Lang "ja" }}埋め込み要素{{ else }}Embedded payment element{{ end }}</p>
          <div id="stripe-payment-element" class="min-h-[140px] rounded-xl border border-gray-200 bg-white p-4 text-sm text-gray-400">
            {{ if eq $.Lang "ja" }}Stripe セッションのクライアントシークレットを待機中...{{ else }}Waiting for Stripe client secret…{{ end }}
          </div>
        </div>
        <div class="grid gap-3 sm:grid-cols-3">
          {{ range $wallet := $view.Wallets }}
            <button type="button" class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm">
              {{ template "icon" (dict "Name" $wallet.Icon "Class" "h-4 w-4 text-indigo-500") }}
              <span>{{ $wallet.Label }}</span>
            </button>
          {{ end }}
        </div>
        <form id="checkout-payment-confirm-form"
              class="space-y-3"
              hx-post="/checkout/payment/confirm"
              hx-target="#checkout-payment-confirm-status"
              hx-swap="innerHTML">
          <input type="hidden" name="session_id" id="checkout-payment-session-id" value="{{ $view.PaymentState.SessionID }}">
          <input type="hidden" name="provider" value="{{ $view.PaymentState.Provider }}">
          <div id="checkout-payment-confirm-status"></div>
          <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-xs uppercase tracking-wide text-gray-400">{{ if eq $.Lang "ja" }}最新ステータス{{ else }}Last status{{ end }}</p>
              <p class="text-sm text-gray-600">
                {{ if $view.PaymentState.SessionID }}
                  {{ if eq $.Lang "ja" }}セッション: {{ $view.PaymentState.SessionID }} · {{ $view.PaymentState.Status }}{{ else }}Session {{ $view.PaymentState.SessionID }} · {{ $view.PaymentState.Status }}{{ end }}
                {{ else }}
                  {{ if eq $.Lang "ja" }}セッションを開始してから続行してください。{{ else }}Start a session before confirming.{{ end }}
                {{ end }}
              </p>
            </div>
            <button type="submit"
                    id="checkout-payment-confirm-btn"
                    class="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-3 text-base font-semibold text-white hover:bg-emerald-500 disabled:pointer-events-none disabled:opacity-50"
                    {{ if not $view.PaymentState.SessionID }}disabled{{ end }}>
              {{ if eq $.Lang "ja" }}支払い完了として進む{{ else }}Confirm & continue{{ end }}
            </button>
          </div>
        </form>
      </section>

      <section class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-500">{{ if eq $.Lang "ja" }}セキュリティ{{ else }}Security{{ end }}</h3>
        <div class="mt-4 grid gap-4 sm:grid-cols-3">
          {{ range $badge := $view.TrustBadges }}
            <div class="flex flex-col gap-1 rounded-xl border border-gray-100 bg-gray-50 p-3 text-sm">
              <div class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-white text-indigo-600">
                {{ template "icon" (dict "Name" $badge.Icon "Class" "h-4 w-4") }}
              </div>
              <p class="font-semibold text-gray-900">{{ $badge.Label }}</p>
              <p class="text-xs text-gray-500">{{ $badge.Body }}</p>
            </div>
          {{ end }}
        </div>
      </section>
    </div>

    <aside class="space-y-4">
      <div id="checkout-payment-summary-shell">
        {{ slot "frag_checkout_summary" (dict "Lang" $.Lang "Summary" $view.Summary "Support" $view.Support) }}
      </div>
    </aside>
  </div>

  <div class="text-xs text-gray-500">Path: {{ $.Path }}</div>
</section>

<div id="checkout-payment-toast" class="pointer-events-none fixed inset-x-0 top-4 z-20 mx-auto hidden max-w-md rounded-xl border border-emerald-200 bg-white p-4 text-sm text-emerald-800 shadow-lg" role="status" aria-live="polite"></div>

<script>
(function(){
  if (window.__checkoutPaymentInit) { return; }
  window.__checkoutPaymentInit = true;
  var sessionInput = document.getElementById('checkout-payment-session-id');
  var confirmBtn = document.getElementById('checkout-payment-confirm-btn');
  var toast = document.getElementById('checkout-payment-toast');
  var stripeElement = document.getElementById('stripe-payment-element');
  var stripeObj = null;
  var stripeElements = null;

  function ensureStripe(callback){
    if (window.Stripe) { callback(); return; }
    var script = document.createElement('script');
    script.src = 'https://js.stripe.com/v3/';
    script.async = true;
    script.onload = callback;
    document.head.appendChild(script);
  }

  function mountStripe(publishableKey, clientSecret){
    if (!publishableKey || !clientSecret || !stripeElement) { return; }
    ensureStripe(function(){
      stripeObj = window.Stripe(publishableKey);
      stripeElements = stripeObj.elements({ clientSecret: clientSecret });
      var element = stripeElements.create('payment');
      element.mount(stripeElement);
      stripeElement.classList.remove('text-gray-400');
    });
  }

  function showToast(message){
    if (!toast) { return; }
    toast.textContent = message || 'Success';
    toast.classList.remove('hidden');
    setTimeout(function(){ toast.classList.add('hidden'); }, 2200);
  }

  function setSessionId(id){
    if (!sessionInput) { return; }
    sessionInput.value = id || '';
    if (confirmBtn) {
      if (id) {
        confirmBtn.removeAttribute('disabled');
      } else {
        confirmBtn.setAttribute('disabled', 'disabled');
      }
    }
  }

  document.body.addEventListener('checkout:payment:session', function(event){
    var detail = event.detail || {};
    if (detail.sessionId) {
      setSessionId(detail.sessionId);
    }
    if (detail.publishableKey && detail.clientSecret) {
      mountStripe(detail.publishableKey, detail.clientSecret);
    } else if (detail.redirectUrl) {
      window.location.href = detail.redirectUrl;
    }
  });

  document.body.addEventListener('checkout:payment:success', function(event){
    var detail = event.detail || {};
    showToast(detail.status ? ('Payment ' + detail.status) : 'Payment confirmed');
    if (detail.nextUrl) {
      setTimeout(function(){ window.location.href = detail.nextUrl; }, 800);
    }
  });
})();
</script>
{{ end }}
