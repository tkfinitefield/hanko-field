{{ define "content" }}
{{ $view := $.Checkout }}
<section id="checkout-shipping-root" class="py-6 space-y-6">
  <header class="space-y-5 rounded-2xl border border-gray-200 bg-white p-6 shadow-sm">
    <nav class="flex flex-wrap items-center gap-2 text-sm text-gray-500" aria-label="{{ if eq $.Lang "ja" }}パンくずリスト{{ else }}Breadcrumb{{ end }}">
      {{ range $i, $crumb := $.Breadcrumbs }}
        {{ if $i }}<span aria-hidden="true" class="text-gray-300">/</span>{{ end }}
        {{ if $crumb.Active }}
          <span class="font-medium text-gray-700">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</span>
        {{ else }}
          <a href="{{ $crumb.Href }}" class="hover:text-indigo-600 hover:underline">{{ if $crumb.LabelKey }}{{ tlang $.Lang $crumb.LabelKey }}{{ else if $crumb.Label }}{{ $crumb.Label }}{{ else }}{{ $crumb.Href }}{{ end }}</a>
        {{ end }}
      {{ end }}
    </nav>
    <div class="space-y-3">
      <p class="text-xs font-semibold uppercase tracking-wide text-indigo-500">{{ if eq $.Lang "ja" }}チェックアウト{{ else }}Checkout{{ end }}</p>
      <h1 class="text-3xl font-bold text-gray-900 leading-tight">{{ if eq $.Lang "ja" }}配送方法の選択{{ else }}Choose your shipping method{{ end }}</h1>
      <p class="text-sm text-gray-600">
        {{ if eq $.Lang "ja" }}
          キャリアごとのスピードとコストを比較し、配送ポリシーに合わせて選択できます。
        {{ else }}
          Compare carriers, transit speeds, and coverage so we can dispatch your seals exactly how you need.
        {{ end }}
      </p>
    </div>
    {{ if $view.Steps }}
      <ol class="grid gap-3 md:grid-cols-4" aria-label="{{ if eq $.Lang "ja" }}進捗状況{{ else }}Checkout progress{{ end }}">
        {{ range $view.Steps }}
          <li class="flex items-center gap-3 rounded-xl border px-3 py-2 text-sm {{ if .Active }}border-indigo-200 bg-indigo-50 text-indigo-700{{ else if .Completed }}border-emerald-200 bg-emerald-50 text-emerald-700{{ else }}border-gray-200 bg-gray-50 text-gray-500{{ end }}">
            <span class="inline-flex h-6 w-6 flex-none items-center justify-center rounded-full text-xs font-semibold {{ if .Active }}bg-indigo-600 text-white{{ else if .Completed }}bg-emerald-500 text-white{{ else }}bg-gray-200 text-gray-600{{ end }}">
              {{ if eq .Key "cart" }}1{{ else if eq .Key "shipping" }}2{{ else if eq .Key "payment" }}3{{ else }}4{{ end }}
            </span>
            <div>
              <p class="font-semibold">{{ .Label }}</p>
              <p class="text-xs text-gray-500">{{ .Description }}</p>
            </div>
          </li>
        {{ end }}
      </ol>
    {{ end }}
    {{ if $view.Alerts }}
      <div class="space-y-3">
        {{ range $alert := $view.Alerts }}
          {{ template "c_inline_alert" (dict "Tone" $alert.Tone "Icon" $alert.Icon "Title" $alert.Title "Body" $alert.Body) }}
        {{ end }}
      </div>
    {{ end }}
  </header>

  <div class="grid gap-6 lg:grid-cols-[minmax(0,7fr)_minmax(0,5fr)]">
    <div class="space-y-6" id="checkout-shipping-options">
      <div id="checkout-shipping-options-shell"
           class="space-y-4"
           hx-get="/checkout/shipping/table{{ if $view.Options.Query }}?{{ $view.Options.Query }}{{ end }}"
           hx-trigger="refresh-shipping-options from:body"
           hx-target="this"
           hx-swap="innerHTML">
        {{ slot "frag_checkout_shipping_table" (dict "Lang" $.Lang "Options" $view.Options "Selected" $view.SelectedMethod) }}
      </div>
    </div>
    <aside class="space-y-4">
      <div id="checkout-shipping-summary-shell"
           data-shipping-query="{{ $view.Options.Query }}">
        {{ slot "frag_checkout_summary" (dict "Lang" $.Lang "Summary" $view.Summary "Support" $view.Support) }}
      </div>
    </aside>
  </div>

  <div class="sticky bottom-3 z-10">
    <form id="checkout-shipping-action"
          class="flex flex-col gap-3 rounded-2xl border border-gray-200 bg-white/95 p-4 shadow-xl backdrop-blur"
          hx-post="/checkout/shipping/submit"
          hx-target="#checkout-shipping-action-status"
          hx-swap="innerHTML">
      <input type="hidden" name="shipping_method" id="shipping-method-input" value="{{ $view.SelectedMethod }}">
      <div id="checkout-shipping-action-status"></div>
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <p class="text-xs text-gray-500">
          {{ if eq $.Lang "ja" }}更新: {{ fmtDate $view.LastUpdated $.Lang }} · {{ $view.Summary.Estimate.ETA }}{{ else }}Updated {{ fmtDate $view.LastUpdated $.Lang }} · {{ $view.Summary.Estimate.ETA }}{{ end }}
        </p>
        <div class="flex flex-col gap-3 md:flex-row md:items-center">
          <a href="{{ $view.BackURL }}" class="inline-flex items-center justify-center rounded-xl border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:border-gray-300">{{ if eq $.Lang "ja" }}住所を変更{{ else }}Back to addresses{{ end }}</a>
          <button type="submit"
                  id="checkout-shipping-continue"
                  class="inline-flex items-center justify-center rounded-xl bg-indigo-600 px-5 py-3 text-base font-semibold text-white hover:bg-indigo-500 disabled:pointer-events-none disabled:opacity-50"
                  {{ if or $view.ShippingStatus.MissingAddress (not $view.SelectedMethod) }}disabled{{ end }}>
            {{ if eq $.Lang "ja" }}支払いへ進む{{ else }}Continue to payment{{ end }}
          </button>
        </div>
      </div>
    </form>
  </div>

  <div class="text-xs text-gray-500">Path: {{ $.Path }}</div>
</section>

<script>
(function(){
  if (window.__checkoutShippingInit) { return; }
  window.__checkoutShippingInit = true;
  var methodInput = document.getElementById('shipping-method-input');
  var summaryShell = document.getElementById('checkout-shipping-summary-shell');

  function ensureHTMX(){
    if (!window.htmx) { throw new Error('htmx missing'); }
    return window.htmx;
  }

  document.addEventListener('change', function(event){
    if (!event.target) { return; }
    if (event.target.name === 'method' && methodInput) {
      methodInput.value = event.target.value || '';
    }
  });

  document.body.addEventListener('checkout:shipping:refresh', function(event){
    var detail = event.detail || {};
    if (detail.method && methodInput) {
      methodInput.value = detail.method;
    }
    if (!summaryShell) { return; }
    var query = detail.query || summaryShell.getAttribute('data-shipping-query') || '';
    summaryShell.setAttribute('data-shipping-query', query);
    var url = '/checkout/shipping/summary';
    if (query) { url += '?' + query; }
    try {
      ensureHTMX().ajax('GET', url, { target: summaryShell, swap: 'innerHTML' });
    } catch (_) {}
  });
})();
</script>
{{ end }}
